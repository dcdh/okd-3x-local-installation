---
- name: Delete dns virtual machine
  vars:
    vm_name: "{{ dns_fqdn }}"
  block:
    - name: Delete {{ vm_name }} virtual machine data
      include: delete_vm.yaml
      vars:
        vm_name: "{{ dns_fqdn }}"
        vm_ip: "{{ dns_ip }}"
    - name: Restore Host NetworkManager.conf
      block:
        - name: Remove dns=none configuration from /etc/NetworkManager/NetworkManager.conf
          lineinfile:
            path: /etc/NetworkManager/NetworkManager.conf
            state: absent
            regexp: '^dns\=none'
            backup: yes
        - name: Unlock /etc/resolv.conf to avoid to be rewritten at startup
          shell: chattr -i /etc/resolv.conf
        - name: Remove dns virtual machine ip {{ dns_ip }} entry into /etc/resolv.conf
          lineinfile:
            path: /etc/resolv.conf
            state: absent
            regexp: '^nameserver {{ dns_ip }}'
            backup: yes
        - name: Reload NetworkManager service
          shell: systemctl reload NetworkManager
      become: true
      become_user: root